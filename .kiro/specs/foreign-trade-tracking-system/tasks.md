# 实施计划：外贸订单管理系统

## 概述

本实施计划将外贸订单管理系统的开发分解为可执行的任务。系统采用前后端分离架构：
- **后端**: Node.js + Express + SQLite (better-sqlite3)
- **前端**: React 18 + TypeScript + Ant Design
- **测试**: Jest + fast-check (基于属性的测试)

实施顺序：项目初始化 → 后端开发 → 前端开发 → 测试 → 集成与部署

## 任务清单

### 1. 项目初始化与环境配置

- [x] 1.1 创建项目目录结构和初始化配置
  - 创建根目录和子目录（backend/, frontend/）
  - 初始化后端项目：`npm init` 并配置 package.json
  - 初始化前端项目：使用 Vite 创建 React + TypeScript 项目
  - 配置 TypeScript (tsconfig.json) 用于后端和前端
  - 配置 ESLint 和 Prettier 用于代码规范
  - 创建 .gitignore 文件
  - _需求: 7.1, 8.1_

- [x] 1.2 安装后端依赖
  - 安装 Express, better-sqlite3, cors, winston
  - 安装开发依赖：typescript, @types/node, @types/express, nodemon, ts-node
  - 安装测试依赖：jest, @types/jest, ts-jest, fast-check, supertest
  - 配置 Jest (jest.config.js)
  - _需求: 7.1, 8.5_

- [x] 1.3 安装前端依赖
  - 安装 Ant Design, axios, react-query, lodash
  - 安装开发依赖：@types/lodash
  - 配置 Vite (vite.config.ts) 包括代理设置
  - _需求: 9.1_

### 2. 数据库层实现

- [x] 2.1 创建数据库初始化模块
  - 实现 DatabaseManager 单例类
  - 创建 orders 表和 customers 表的 SQL schema
  - 实现数据库表自动创建逻辑
  - 创建索引（company_name, order_date, country, continent）
  - 配置 WAL 模式提高并发性能
  - _需求: 7.1, 7.5_

- [ ]* 2.2 编写数据库初始化的属性测试
  - **属性27: 写入持久性**
  - **验证需求: 7.1**

- [x] 2.3 实现数据访问层 (DAO)
  - 创建 OrderDAO 类：insert, update, delete, findById, query 方法
  - 创建 CustomerDAO 类：insert, update, delete, findByCompanyName, list 方法
  - 实现参数化查询防止 SQL 注入
  - 实现事务支持（使用 better-sqlite3 的 transaction API）
  - _需求: 7.1, 7.2, 7.4_

- [ ]* 2.4 编写 DAO 层的单元测试
  - 测试 CRUD 操作
  - 测试事务回滚
  - 测试错误处理
  - _需求: 7.1, 7.2, 7.4_

### 3. 后端服务层实现

- [x] 3.1 实现 OrderService - 订单创建逻辑
  - 实现 createOrder 方法
  - 实现必填字段验证（订单日期、公司名、客户信息、线索编号）
  - 实现邮箱格式验证
  - 实现数字字段验证（发票金额、到款金额）
  - 实现客户自动创建或关联逻辑（检查 company_name 是否存在）
  - 使用事务确保订单和客户操作的原子性
  - 自动设置 created_at 和 updated_at 时间戳
  - _需求: 1.1, 1.2, 1.3, 1.4, 1.5, 3.1, 3.2_

- [ ]* 3.2 编写订单创建的属性测试
  - **属性1: 必填字段验证**
  - **验证需求: 1.1, 2.2**

- [ ]* 3.3 编写订单创建的属性测试
  - **属性2: 联系人信息完整性**
  - **验证需求: 1.2**

- [ ]* 3.4 编写订单创建的属性测试
  - **属性3: 邮箱格式验证**
  - **验证需求: 1.3**

- [ ]* 3.5 编写订单创建的属性测试
  - **属性4: 数字字段验证**
  - **验证需求: 1.4**

- [ ]* 3.6 编写订单创建的属性测试
  - **属性5: 时间戳自动生成**
  - **验证需求: 1.5**

- [ ]* 3.7 编写客户管理的属性测试
  - **属性8: 客户自动创建**
  - **验证需求: 3.1**

- [ ]* 3.8 编写客户管理的属性测试
  - **属性9: 客户关联复用**
  - **验证需求: 3.2**

- [x] 3.9 实现 OrderService - 订单更新逻辑
  - 实现 updateOrder 方法
  - 加载现有订单数据
  - 验证必填字段
  - 更新 updated_at 时间戳（保持 created_at 不变）
  - 同步更新客户商机信息（如果订单的 businessOpportunity 字段被更新）
  - _需求: 2.1, 2.2, 3.3, 3.4_

- [ ]* 3.10 编写订单更新的属性测试
  - **属性6: 订单更新保持性**
  - **验证需求: 2.1**

- [ ]* 3.11 编写客户商机同步的属性测试
  - **属性12: 客户商机同步**
  - **验证需求: 3.3**

- [ ]* 3.12 编写客户商机一致性的属性测试
  - **属性13: 客户商机一致性**
  - **验证需求: 3.4**

- [x] 3.13 实现 OrderService - 订单删除逻辑
  - 实现 deleteOrder 方法
  - 提示用户确认删除
  - 删除订单记录
  - 检查该客户是否还有其他订单
  - 如果没有其他订单，删除客户记录
  - 如果有其他订单，保留客户记录
  - 使用事务确保原子性
  - _需求: 2.3, 2.4, 2.5_

- [ ]* 3.14 编写订单删除的属性测试
  - **属性7: 订单删除后不可见**
  - **验证需求: 2.3**

- [ ]* 3.15 编写客户级联删除的属性测试
  - **属性10: 客户级联删除 - 保留情况**
  - **验证需求: 2.4**

- [ ]* 3.16 编写客户级联删除的属性测试
  - **属性11: 客户级联删除 - 清理情况**
  - **验证需求: 2.5**

- [x] 3.17 实现 OrderService - 订单查询逻辑
  - 实现 queryOrders 方法，支持9个查询条件
  - 实现日期范围筛选（startDate, endDate）
  - 实现模糊搜索（公司名称、客户名称、国家、大洲、来源、客户性质）
  - 实现精确匹配（新老客户、客户等级）
  - 实现多条件 AND 组合逻辑
  - 实现空条件忽略逻辑
  - 实现分页支持（page, pageSize）
  - _需求: 4.1, 4.2, 4.3-4.10, 4.12, 4.13, 4.15_

- [ ]* 3.18 编写查询功能的属性测试
  - **属性15: 分页正确性**
  - **验证需求: 4.1, 5.2**

- [ ]* 3.19 编写查询功能的属性测试
  - **属性16: 日期范围筛选**
  - **验证需求: 4.3-4.10**

- [ ]* 3.20 编写查询功能的属性测试
  - **属性17: 模糊搜索正确性**
  - **验证需求: 4.3-4.10**

- [ ]* 3.21 编写查询功能的属性测试
  - **属性18: 精确匹配筛选**
  - **验证需求: 4.5, 4.6**

- [ ]* 3.22 编写查询功能的属性测试
  - **属性19: 多条件AND组合**
  - **验证需求: 4.15**

- [ ]* 3.23 编写查询功能的属性测试
  - **属性20: 空条件忽略**
  - **验证需求: 4.15**

- [x] 3.24 实现 OrderService - 获取单个订单
  - 实现 getOrderById 方法
  - 处理订单不存在的情况（返回 null）
  - _需求: 2.1_

### 4. 后端客户服务层实现

- [x] 4.1 实现 CustomerService
  - 实现 getCustomers 方法（按公司名去重，支持分页）
  - 实现 getCustomerOrders 方法（获取某个客户的所有订单，支持分页）
  - 实现 updateBusinessOpportunity 方法（更新客户商机）
  - _需求: 3.5, 4.14, 5.1, 5.2, 5.3_

- [ ]* 4.2 编写客户服务的属性测试
  - **属性14: 客户列表去重**
  - **验证需求: 3.5**

- [ ]* 4.3 编写客户订单查询的属性测试
  - **属性21: 客户订单完整查询**
  - **验证需求: 4.14, 5.1**

### 5. 后端统计服务层实现

- [x] 5.1 实现 StatisticsService - 基础统计
  - 实现 calculateStatistics 方法
  - 计算订单总数（COUNT(*)）
  - 计算客户总数（COUNT(DISTINCT company_name)）
  - 计算发票金额总计（SUM(invoice_amount)）
  - 计算到款金额总计（SUM(payment_amount)）
  - 支持日期范围筛选
  - _需求: 6.1, 6.2_

- [ ]* 5.2 编写统计功能的属性测试
  - **属性22: 订单计数准确性**
  - **验证需求: 6.1**

- [ ]* 5.3 编写统计功能的属性测试
  - **属性23: 客户计数去重**
  - **验证需求: 6.1**

- [ ]* 5.4 编写统计功能的属性测试
  - **属性24: 金额求和准确性**
  - **验证需求: 6.2**

- [x] 5.5 实现 StatisticsService - 分组统计
  - 实现按国家分组统计（GROUP BY country）
  - 实现按大洲分组统计（GROUP BY continent）
  - 实现按客户等级分组统计（GROUP BY customer_level）
  - _需求: 6.3_

- [ ]* 5.6 编写分组统计的属性测试
  - **属性25: 分组统计正确性**
  - **验证需求: 6.3**

- [x] 5.7 实现 StatisticsService - 月度趋势
  - 实现按月份统计订单数量（GROUP BY strftime('%Y-%m', order_date)）
  - 实现按月份统计发票金额和到款金额
  - 返回月度趋势数组
  - _需求: 6.4_

- [ ]* 5.8 编写月度趋势的属性测试
  - **属性26: 月度趋势连续性**
  - **验证需求: 6.4**

- [x] 5.9 实现 StatisticsService - Excel 报表导出
  - 安装 exceljs 库
  - 实现 generateExcelReport 方法
  - 生成包含订单明细的 Excel 文件
  - 包含所有订单字段和格式化
  - _需求: 6.5_

### 6. 后端 API 路由层实现

- [x] 6.1 实现订单相关 API 路由
  - POST /api/orders - 创建订单
  - GET /api/orders - 查询订单列表（支持查询参数）
  - GET /api/orders/:id - 获取单个订单
  - PUT /api/orders/:id - 更新订单
  - DELETE /api/orders/:id - 删除订单
  - 实现参数验证
  - 实现错误处理
  - _需求: 8.1, 8.2, 8.3, 8.4_

- [x] 6.2 实现客户相关 API 路由
  - GET /api/customers - 查询客户列表
  - GET /api/customers/:companyName/orders - 获取客户的所有订单
  - PUT /api/customers/:companyName - 更新客户商机
  - _需求: 8.1, 8.2_

- [x] 6.3 实现统计相关 API 路由
  - GET /api/statistics - 获取统计数据
  - GET /api/export - 导出 Excel 报表
  - _需求: 8.1, 8.2_

- [x] 6.4 实现全局错误处理中间件
  - 处理验证错误（400）
  - 处理资源不存在错误（404）
  - 处理数据库错误（500）
  - 记录错误日志
  - 返回标准错误响应格式
  - _需求: 7.3, 8.3_

- [x] 6.5 配置 CORS 和中间件
  - 配置 CORS 策略
  - 配置 JSON body parser
  - 配置请求日志中间件
  - _需求: 8.5_

- [ ]* 6.6 编写 API 接口的属性测试
  - **属性29: 响应格式一致性**
  - **验证需求: 8.1, 8.2**

- [ ]* 6.7 编写 API 接口的属性测试
  - **属性30: 错误状态码正确性**
  - **验证需求: 8.3**

- [ ]* 6.8 编写 API 接口的属性测试
  - **属性31: 参数验证完整性**
  - **验证需求: 8.4**

- [ ]* 6.9 编写事务原子性的属性测试
  - **属性28: 事务原子性**
  - **验证需求: 7.4**

### 7. 检查点 - 后端完成

- [x] 7. 后端检查点
  - 运行所有后端测试确保通过
  - 验证所有 API 端点可以正常访问
  - 检查数据库操作正确性
  - 如有问题，询问用户

### 8. 前端基础设施

- [x] 8.1 创建前端项目结构和类型定义
  - 创建目录结构（components/, services/, context/, utils/, types/）
  - 定义 TypeScript 类型（Order, Customer, ContactInfo, QueryParams, Statistics）
  - 创建 API 响应类型（ApiResponse）
  - _需求: 9.1_

- [x] 8.2 实现 API 服务层
  - 创建 Axios 实例并配置 baseURL
  - 实现请求拦截器
  - 实现响应拦截器（错误处理）
  - 创建订单相关 API 方法（createOrder, updateOrder, deleteOrder, queryOrders, getOrderById）
  - 创建客户相关 API 方法（getCustomers, getCustomerOrders, updateBusinessOpportunity）
  - 创建统计相关 API 方法（getStatistics, exportExcel）
  - _需求: 8.1, 9.4_

- [x] 8.3 实现全局状态管理（Context API）
  - 创建 AppContext 和 AppProvider
  - 定义 AppState 接口（orders, customers, statistics, loading, error, queryParams）
  - 实现 actions（fetchOrders, createOrder, updateOrder, deleteOrder, fetchCustomers, fetchStatistics）
  - 实现错误处理和加载状态管理
  - _需求: 9.1_

- [x] 8.4 实现工具函数
  - 创建表单验证函数（validateEmail, validateRequired, validateNumber）
  - 创建数据格式化函数（formatDate, formatCurrency）
  - 创建防抖函数（使用 lodash.debounce）
  - _需求: 1.3, 1.4, 4.3-4.10, 9.2_

### 9. 前端订单管理组件

- [x] 9.1 实现 ContactInfoInput 组件
  - 创建动态联系人输入组件
  - 支持添加新联系人
  - 支持删除联系人
  - 实现实时验证（姓名、邮箱、电话）
  - 使用 Ant Design Form.List
  - _需求: 1.2, 9.3_

- [x] 9.2 实现 OrderForm 组件
  - 创建订单表单组件（使用 Ant Design Form）
  - 实现必填字段（订单日期、公司名、客户信息、线索编号）
  - 实现可选字段（新老客户、客户等级、国家、大洲、来源、客户性质、发票金额、到款金额）
  - 集成 ContactInfoInput 组件
  - 实现表单验证（邮箱格式、数字格式）
  - 实现提交逻辑（调用 createOrder 或 updateOrder）
  - 显示加载状态和错误提示
  - _需求: 1.1, 1.2, 1.3, 1.4, 9.2, 9.3, 9.4, 9.5_

- [ ]* 9.3 编写前端验证的属性测试
  - **属性32: 前端验证一致性**
  - **验证需求: 9.2**

- [x] 9.4 实现 OrderTable 组件
  - 创建订单列表表格（使用 Ant Design Table）
  - 显示所有订单字段
  - 实现分页（pageSize: 20, showSizeChanger, showTotal）
  - 实现公司名点击事件（打开客户订单弹窗）
  - 实现编辑和删除操作
  - 显示加载状态
  - _需求: 4.1, 4.14, 9.1_

### 10. 前端查询界面

- [x] 10.1 实现 QueryForm 组件 - 基础结构
  - 创建查询表单组件（使用 Ant Design Form）
  - 实现日期范围选择器（RangePicker，默认值：当年1月1日 - 12月31日）
  - 实现6个文本输入框（公司名称、客户名称、国家、大洲、来源、客户性质）
  - 实现2个下拉选择器（新老客户、客户等级）
  - _需求: 4.2, 10.1, 10.2, 10.3, 10.4_

- [x] 10.2 实现 QueryForm 组件 - 交互逻辑
  - 实现文本输入框的500ms防抖
  - 实现日期范围变化时自动触发查询
  - 实现"搜索"按钮点击事件
  - 实现"重置"按钮点击事件（清空条件并恢复默认日期）
  - 实现空条件忽略逻辑
  - 调用 Context 的 fetchOrders action
  - _需求: 4.3-4.11, 4.13, 10.5, 10.6, 10.7, 10.8, 10.9_

- [x] 10.3 实现 OrderList 组件
  - 组合 QueryForm 和 OrderTable 组件
  - 实现页面初始化时自动查询当年数据
  - 实现"新建订单"按钮（打开 OrderForm）
  - 使用 Context 获取订单数据和状态
  - _需求: 4.1, 4.2, 9.1_

### 11. 前端客户订单弹窗

- [x] 11.1 实现 CustomerModal 组件
  - 创建客户订单弹窗（使用 Ant Design Modal）
  - 显示客户商机信息
  - 显示该客户的所有订单（使用 Table 组件）
  - 实现分页（pageSize: 10）
  - 支持在弹窗中编辑订单
  - 实现关闭弹窗时刷新主列表
  - _需求: 5.1, 5.2, 5.3, 5.4, 5.5_

### 12. 前端统计报表组件

- [x] 12.1 实现 StatisticsPanel 组件
  - 创建统计面板组件
  - 显示订单总数、客户总数
  - 显示发票金额总计、到款金额总计
  - 使用 Ant Design Statistic 组件
  - _需求: 6.1, 6.2_

- [x] 12.2 实现 Charts 组件
  - 安装图表库（如 recharts 或 @ant-design/charts）
  - 实现按国家分布的柱状图
  - 实现按大洲分布的饼图
  - 实现按客户等级分布的饼图
  - 实现月度趋势的折线图（订单数量和金额）
  - _需求: 6.3, 6.4_

- [x] 12.3 实现 Statistics 页面
  - 组合 StatisticsPanel 和 Charts 组件
  - 实现日期范围选择器（筛选统计数据）
  - 实现"导出报表"按钮（调用导出 API）
  - 使用 Context 获取统计数据
  - _需求: 6.1, 6.2, 6.3, 6.4, 6.5_

### 13. 前端路由和主应用

- [x] 13.1 实现路由配置
  - 安装 react-router-dom
  - 配置路由（/orders, /statistics）
  - 创建导航菜单（使用 Ant Design Menu）
  - 创建主布局组件（使用 Ant Design Layout）
  - _需求: 9.1_

- [x] 13.2 实现 App 组件
  - 包裹 AppProvider（Context）
  - 包裹 QueryClientProvider（react-query）
  - 包裹 BrowserRouter
  - 渲染主布局和路由
  - 配置全局样式
  - _需求: 9.1_

### 14. 检查点 - 前端完成

- [x] 14. 前端检查点
  - 启动前端开发服务器
  - 测试所有页面和组件功能
  - 验证表单验证和错误处理
  - 验证与后端 API 的集成
  - 如有问题，询问用户

### 15. 集成测试

- [ ]* 15.1 编写端到端集成测试
  - 测试完整的订单创建、更新、删除流程
  - 测试客户自动创建和关联
  - 测试查询功能的多条件组合
  - 测试统计数据的准确性
  - 使用 supertest 测试 API 端点
  - _需求: 所有需求_

- [ ]* 15.2 运行所有测试并生成覆盖率报告
  - 运行后端单元测试
  - 运行基于属性的测试（每个属性至少100次迭代）
  - 运行集成测试
  - 生成代码覆盖率报告
  - 确保覆盖率达到80%以上

### 16. 性能优化

- [x] 16.1 实现数据库查询优化
  - 验证索引是否正确创建
  - 优化复杂查询的 SQL 语句
  - 实现查询结果缓存（如适用）
  - _需求: 7.2_

- [x] 16.2 实现前端性能优化
  - 验证防抖功能正常工作（500ms）
  - 实现虚拟滚动（如数据量大）
  - 配置 react-query 缓存策略
  - 优化组件渲染（使用 React.memo）
  - _需求: 4.3-4.10_

### 17. 部署准备

- [x] 17.1 配置生产环境
  - 创建生产环境配置文件（.env.production）
  - 配置环境变量（数据库路径、端口、CORS 来源）
  - 创建 PM2 配置文件（ecosystem.config.js）
  - 创建 Nginx 配置文件
  - _需求: 8.5_

- [x] 17.2 实现日志和监控
  - 配置 winston 日志记录
  - 实现 API 请求日志
  - 实现错误日志
  - 配置日志文件轮转
  - _需求: 7.3_

- [ ] 17.3 实现数据备份策略
  - 创建数据库备份脚本
  - 配置定时备份（cron job）
  - 实现备份文件清理（保留30天）
  - _需求: 7.1_

- [x] 17.4 构建生产版本
  - 构建前端生产版本（npm run build）
  - 构建后端生产版本（TypeScript 编译）
  - 测试生产版本运行
  - 创建部署文档

### 18. 最终检查点

- [ ] 18. 最终验收
  - 运行所有测试确保通过
  - 验证所有32个正确性属性
  - 验证所有功能需求
  - 检查性能指标
  - 准备交付文档
  - 如有问题，询问用户

## 注意事项

- 标记为 `*` 的任务是可选的测试任务，可以跳过以加快 MVP 开发
- 每个任务都引用了具体的需求编号以确保可追溯性
- 检查点任务确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边界情况
- 基于属性的测试使用 fast-check 库，每个属性至少运行100次迭代
