# 需求文档

## 简介

本文档描述订单管理系统的功能增强需求，包括在订单表单中添加新字段以及增强客户分析模块的采购习惯分析功能。

## 术语表

- **订单系统（Order_System）**: 管理客户订单的系统，包括订单创建、编辑和查询功能
- **订单表单（Order_Form）**: 用于创建和编辑订单信息的用户界面表单
- **客户分析模块（Customer_Analysis_Module）**: 提供客户数据分析和洞察的系统模块
- **采购习惯分析（Purchase_Behavior_Analysis）**: 客户分析模块中分析客户采购模式的功能部分
- **成单产品（Closed_Product）**: 客户成功采购的产品
- **EXW货值（EXW_Value）**: Ex Works（工厂交货）价格，国际贸易术语之一
- **客户背调（Customer_Background_Check）**: 对客户背景信息的调查记录
- **前端（Frontend）**: 用户界面层，负责展示和用户交互
- **后端（Backend）**: 服务器端应用程序，负责业务逻辑和数据处理
- **数据库（Database）**: 持久化存储系统数据的关系型数据库

## 需求

### 需求 1：订单表单新字段

**用户故事：** 作为订单管理员，我希望在订单表单中记录更多订单相关信息，以便更全面地跟踪和管理订单数据。

#### 验收标准

1. WHEN 用户创建或编辑订单时，THE 订单表单 SHALL 显示"客户背调"输入字段
2. WHEN 用户创建或编辑订单时，THE 订单表单 SHALL 显示"成单产品"输入字段
3. WHEN 用户创建或编辑订单时，THE 订单表单 SHALL 显示"到款日期"日期选择器
4. WHEN 用户创建或编辑订单时，THE 订单表单 SHALL 显示"EXW货值"输入字段
5. WHEN 用户提交订单表单且"成单产品"字段为空时，THE 订单系统 SHALL 阻止提交并显示验证错误消息
6. WHEN 用户提交包含新字段的有效订单表单时，THE 后端 SHALL 接收并验证所有新字段数据
7. WHEN 后端接收到有效的订单数据时，THE 数据库 SHALL 持久化存储所有新字段的值

### 需求 2：数据库架构更新

**用户故事：** 作为系统架构师，我希望数据库能够存储新的订单字段，以便支持业务数据的完整性。

#### 验收标准

1. THE 数据库 SHALL 在订单表中包含"customer_background_check"字段用于存储客户背调信息
2. THE 数据库 SHALL 在订单表中包含"closed_product"字段用于存储成单产品信息
3. THE 数据库 SHALL 在订单表中包含"payment_date"字段用于存储到款日期
4. THE 数据库 SHALL 在订单表中包含"exw_value"字段用于存储EXW货值
5. THE 数据库 SHALL 将"closed_product"字段设置为非空约束
6. WHEN 插入或更新订单记录时，THE 数据库 SHALL 强制执行"closed_product"字段的非空约束

### 需求 3：后端API支持

**用户故事：** 作为前端开发者，我希望后端API能够处理新的订单字段，以便前端能够正确提交和获取订单数据。

#### 验收标准

1. WHEN 前端发送创建订单请求时，THE 后端API SHALL 接受并处理所有新字段（客户背调、成单产品、到款日期、EXW货值）
2. WHEN 前端发送更新订单请求时，THE 后端API SHALL 接受并处理所有新字段的更新
3. WHEN 后端API接收到缺少"成单产品"字段的请求时，THE 后端API SHALL 返回400错误和描述性错误消息
4. WHEN 前端请求订单详情时，THE 后端API SHALL 在响应中包含所有新字段的值
5. WHEN 后端API接收到"到款日期"字段时，THE 后端API SHALL 验证其为有效的日期格式
6. WHEN 后端API接收到"EXW货值"字段时，THE 后端API SHALL 验证其为有效的数值格式

### 需求 4：客户分析模块增强

**用户故事：** 作为销售经理，我希望在客户分析模块中查看客户的Top5成单产品，以便了解客户的采购偏好和习惯。

#### 验收标准

1. WHEN 用户访问客户分析模块的采购习惯分析部分时，THE 客户分析模块 SHALL 显示"Top5成单产品"排行榜
2. WHEN 系统计算Top5成单产品时，THE 客户分析模块 SHALL 基于当前客户的所有订单中的成单产品进行统计
3. WHEN 系统展示Top5成单产品时，THE 客户分析模块 SHALL 按照产品出现频次从高到低排序
4. WHEN 客户的成单产品少于5种时，THE 客户分析模块 SHALL 显示所有可用的成单产品
5. WHEN 客户没有任何成单产品时，THE 客户分析模块 SHALL 显示友好的空状态提示消息
6. WHEN Top5成单产品数据加载时，THE 客户分析模块 SHALL 显示加载指示器
7. WHEN Top5成单产品数据加载失败时，THE 客户分析模块 SHALL 显示错误消息并提供重试选项

### 需求 5：数据查询和聚合

**用户故事：** 作为系统开发者，我希望能够高效地查询和聚合客户的成单产品数据，以便为客户分析模块提供准确的统计信息。

#### 验收标准

1. WHEN 客户分析模块请求Top5成单产品数据时，THE 后端 SHALL 查询指定客户的所有订单记录
2. WHEN 后端查询订单记录时，THE 后端 SHALL 提取所有非空的成单产品字段
3. WHEN 后端处理成单产品数据时，THE 后端 SHALL 按产品名称进行分组并计算每个产品的出现次数
4. WHEN 后端完成聚合计算时，THE 后端 SHALL 返回按频次降序排列的前5个产品及其统计数据
5. WHEN 后端返回Top5数据时，THE 后端 SHALL 包含产品名称和出现次数
