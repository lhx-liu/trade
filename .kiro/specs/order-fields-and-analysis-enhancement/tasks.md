# 实施计划：订单字段和分析增强

## 概述

本实施计划将订单管理系统的功能增强分解为可执行的编码任务。实施分为三个主要阶段：数据库架构更新、后端API开发、前端UI开发。每个阶段都包含相应的测试任务，确保功能的正确性和可靠性。

## 任务列表

- [ ] 1. 数据库架构更新
  - [x] 1.1 编写并执行数据库迁移脚本
    - 在订单表中添加4个新字段：customer_background_check（TEXT）、closed_product（VARCHAR NOT NULL）、payment_date（DATE）、exw_value（DECIMAL）
    - 创建索引：idx_orders_closed_product 和 idx_orders_customer_product
    - 编写回滚脚本以备不时之需
    - _需求：2.1, 2.2, 2.3, 2.4, 2.5_
  
  - [ ]* 1.2 编写数据库架构验证测试
    - 验证所有新字段存在且类型正确
    - 验证closed_product字段的NOT NULL约束
    - 验证索引创建成功
    - _需求：2.1, 2.2, 2.3, 2.4, 2.5_
  
  - [ ]* 1.3 编写属性测试：成单产品非空约束
    - **属性 2：成单产品必填验证（数据库层）**
    - **验证需求：2.6**
    - 生成缺少closed_product的订单数据，验证数据库拒绝插入/更新操作

- [ ] 2. 后端数据模型和类型定义
  - [x] 2.1 更新订单数据模型接口
    - 在TypeScript接口中添加4个新字段的类型定义
    - 更新Order类型，标记closedProduct为必填
    - _需求：1.6, 3.1, 3.2_
  
  - [x] 2.2 实现订单数据验证函数
    - 验证closedProduct非空
    - 验证paymentDate为有效日期格式（ISO 8601）
    - 验证exwValue为有效数值格式
    - _需求：3.3, 3.5, 3.6_
  
  - [ ]* 2.3 编写单元测试：数据验证函数
    - 测试各种有效和无效的输入
    - 测试边界情况（空字符串、null、undefined）
    - _需求：3.3, 3.5, 3.6_

- [ ] 3. 后端订单API实现
  - [x] 3.1 更新创建订单API端点
    - 修改POST /api/orders接口，接受新字段
    - 调用验证函数验证输入
    - 将新字段保存到数据库
    - 返回适当的成功/错误响应
    - _需求：3.1, 3.3_
  
  - [x] 3.2 更新订单详情查询API端点
    - 修改GET /api/orders/:orderId接口
    - 确保响应包含所有新字段
    - _需求：3.4_
  
  - [x] 3.3 更新订单更新API端点
    - 修改PUT /api/orders/:orderId接口，接受新字段的更新
    - 调用验证函数验证输入
    - 更新数据库中的新字段
    - _需求：3.2_
  
  - [ ]* 3.4 编写属性测试：订单数据完整性（Round-trip）
    - **属性 1：订单数据完整性（Round-trip）**
    - **验证需求：1.7, 3.4**
    - 生成随机订单数据（包含新字段），创建订单后查询，验证数据一致性
  
  - [ ]* 3.5 编写属性测试：新字段API处理
    - **属性 3：新字段API处理**
    - **验证需求：3.1, 3.2**
    - 生成包含所有新字段的随机订单数据，验证创建和更新API正确处理
  
  - [ ]* 3.6 编写属性测试：日期格式验证
    - **属性 4：日期格式验证**
    - **验证需求：3.5**
    - 生成无效日期格式，验证API返回400错误
  
  - [ ]* 3.7 编写属性测试：数值格式验证
    - **属性 5：数值格式验证**
    - **验证需求：3.6**
    - 生成无效数值格式，验证API返回400错误
  
  - [ ]* 3.8 编写属性测试：成单产品必填验证（API层）
    - **属性 2：成单产品必填验证（API层）**
    - **验证需求：1.5, 3.3**
    - 生成缺少成单产品的订单数据，验证API返回400错误

- [ ] 4. 检查点 - 确保订单API测试通过
  - 运行所有订单相关的单元测试和属性测试
  - 确保所有测试通过，如有问题请向用户询问

- [ ] 5. 后端客户分析服务实现
  - [x] 5.1 实现Top5成单产品查询服务
    - 创建CustomerAnalysisService类
    - 实现getTopProducts方法：查询指定客户的所有订单，提取非空的closed_product字段，按产品名称分组计数，按频次降序排序，返回前5个
    - 处理边界情况：产品少于5种、没有产品
    - _需求：4.2, 4.3, 4.4, 4.5, 5.1, 5.2, 5.3, 5.4, 5.5_
  
  - [ ]* 5.2 编写单元测试：Top5统计算法
    - 测试正常情况（5种以上产品）
    - 测试边界情况（少于5种产品、0种产品）
    - 测试排序正确性
    - _需求：4.2, 4.3, 4.4, 4.5_
  
  - [ ]* 5.3 编写属性测试：Top5产品统计正确性
    - **属性 6：Top5产品统计正确性**
    - **验证需求：4.2, 4.3, 5.1, 5.2, 5.3, 5.4, 5.5**
    - 生成随机客户和订单数据，验证统计结果的正确性（只统计非空、正确分组计数、降序排列、包含名称和次数）
  
  - [ ]* 5.4 编写属性测试：Top5产品排序单调性
    - **属性 7：Top5产品排序单调性**
    - **验证需求：4.3**
    - 生成随机订单数据，验证返回列表中相邻产品的次数满足降序关系
  
  - [ ]* 5.5 编写属性测试：Top5产品数量限制
    - **属性 8：Top5产品数量限制**
    - **验证需求：4.4**
    - 生成不同数量的产品数据，验证返回列表长度正确（<5时返回实际数量，>=5时返回5）

- [ ] 6. 后端客户分析API实现
  - [x] 6.1 创建Top5成单产品API端点
    - 实现GET /api/customers/:customerId/top-products?limit=5接口
    - 调用CustomerAnalysisService.getTopProducts方法
    - 返回JSON格式的Top5产品数据
    - 处理错误情况（客户不存在、服务器错误）
    - _需求：4.1, 4.2, 4.3_
  
  - [ ]* 6.2 编写API集成测试：Top5查询端点
    - 使用Supertest测试完整的API调用流程
    - 测试成功响应和错误响应
    - _需求：4.1, 4.2, 4.3_

- [ ] 7. 检查点 - 确保客户分析API测试通过
  - 运行所有客户分析相关的单元测试和属性测试
  - 确保所有测试通过，如有问题请向用户询问

- [ ] 8. 前端订单表单组件更新
  - [x] 8.1 更新订单表单UI
    - 在OrderForm组件中添加4个新字段的表单项
    - 使用Ant Design的Input组件（客户背调、成单产品、EXW货值）
    - 使用Ant Design的DatePicker组件（到款日期）
    - 标记成单产品为必填项（添加红色星号）
    - _需求：1.1, 1.2, 1.3, 1.4_
  
  - [x] 8.2 实现前端表单验证
    - 添加成单产品非空验证规则
    - 添加到款日期格式验证规则
    - 添加EXW货值数值格式验证规则
    - 显示适当的错误提示消息
    - _需求：1.5_
  
  - [x] 8.3 更新表单提交逻辑
    - 修改表单提交函数，包含新字段数据
    - 使用Axios发送POST/PUT请求到后端API
    - 处理API响应（成功/失败）
    - _需求：1.6_
  
  - [ ]* 8.4 编写前端组件测试：订单表单渲染
    - 使用React Testing Library测试表单渲染
    - 验证所有新字段的表单项存在
    - 验证成单产品标记为必填
    - _需求：1.1, 1.2, 1.3, 1.4_
  
  - [ ]* 8.5 编写前端组件测试：表单验证
    - 测试成单产品为空时显示错误
    - 测试无效日期格式时显示错误
    - 测试无效数值格式时显示错误
    - _需求：1.5_

- [ ] 9. 前端客户分析组件更新
  - [x] 9.1 创建Top5成单产品展示组件
    - 在CustomerAnalysis组件的采购习惯分析部分添加新的子组件
    - 使用Ant Design的List或Table组件展示排行榜
    - 显示产品名称、采购次数、排名
    - _需求：4.1, 4.3_
  
  - [x] 9.2 实现数据加载逻辑
    - 使用Axios调用GET /api/customers/:customerId/top-products接口
    - 使用React Context API或useState管理组件状态
    - 实现加载状态（显示Spin组件）
    - 实现错误状态（显示错误消息和重试按钮）
    - 实现空状态（显示"暂无成单产品数据"）
    - _需求：4.6, 4.7, 4.5_
  
  - [ ]* 9.3 编写前端组件测试：Top5组件渲染
    - 测试组件正常渲染Top5列表
    - 测试加载状态显示
    - 测试错误状态显示
    - 测试空状态显示
    - _需求：4.1, 4.6, 4.7, 4.5_

- [ ] 10. 最终集成测试和验证
  - [ ]* 10.1 编写端到端集成测试
    - 测试完整的订单创建流程（前端 → API → 数据库 → API → 前端）
    - 测试完整的订单更新流程
    - 测试完整的Top5查询流程
    - _需求：所有需求_
  
  - [ ] 10.2 手动验证和用户验收
    - 在开发环境中手动测试所有功能
    - 验证UI展示符合预期
    - 验证数据正确保存和查询
    - 向用户演示功能，收集反馈

- [ ] 11. 最终检查点
  - 确保所有测试通过
  - 确保代码质量符合团队标准
  - 如有问题请向用户询问

## 注意事项

- 标记为 `*` 的任务为可选任务，可以跳过以加快MVP开发
- 每个任务都引用了具体的需求编号，便于追溯
- 属性测试应配置为运行至少100次迭代
- 检查点任务确保增量验证，及早发现问题
- 建议按顺序执行任务，确保依赖关系正确
