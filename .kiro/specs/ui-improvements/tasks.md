# 实现计划: UI改进功能

## 概述

本实现计划将外贸订单管理系统的三个UI改进功能分解为可执行的编码任务。任务按照功能模块组织，每个任务都是独立的、可测试的代码修改。

## 任务

- [x] 1. 实现订单表单商机录入功能
  - [x] 1.1 在OrderForm组件中添加商机输入字段
    - 在frontend/src/components/OrderForm/OrderForm.tsx中添加商机输入字段
    - 使用Ant Design的Input.TextArea组件
    - 添加字符长度验证（最大500字符）
    - 添加字符计数器显示
    - _需求: 1.1, 1.2_
  
  - [ ]* 1.2 编写商机字段的单元测试
    - 测试商机字段是否正确渲染
    - 测试字符长度验证规则
    - 测试字符计数器显示
    - _需求: 1.1, 1.2_
  
  - [ ]* 1.3 编写商机字符限制的属性测试
    - **属性 1: 商机输入字符限制**
    - **验证需求: 1.2**
  
  - [x] 1.4 修改OrderForm表单提交逻辑
    - 在handleSubmit函数中提取businessOpportunity字段
    - 将商机信息作为额外参数传递给API
    - 确保商机信息不包含在订单数据中
    - _需求: 1.3_
  
  - [x] 1.5 实现编辑时加载客户商机信息
    - 在useEffect中添加客户信息加载逻辑
    - 调用customerApi.getCustomer获取客户信息
    - 将商机信息填充到表单字段
    - 处理加载失败的情况
    - _需求: 1.4_
  
  - [ ]* 1.6 编写商机加载的单元测试
    - 测试编辑订单时是否加载商机信息
    - 测试加载失败时的错误处理
    - _需求: 1.4_
  
  - [ ]* 1.7 编写商机加载的属性测试
    - **属性 3: 编辑时加载现有商机**
    - **验证需求: 1.4**

- [x] 2. 修改后端API支持商机信息
  - [x] 2.1 扩展Order类型定义
    - 在backend/src/types/index.ts中为Order接口添加可选的businessOpportunity字段
    - 仅用于API传输，不存储在orders表
    - _需求: 1.3_
  
  - [x] 2.2 修改OrderService.createOrder方法
    - 提取businessOpportunity字段
    - 检查客户是否存在
    - 创建或更新客户记录时包含商机信息
    - 使用事务确保原子性
    - _需求: 1.3, 1.5, 4.1, 4.2, 4.3_
  
  - [x] 2.3 修改OrderService.updateOrder方法
    - 提取businessOpportunity字段
    - 更新客户记录的商机信息
    - 使用事务确保原子性
    - _需求: 1.3, 1.5, 4.1, 4.3_
  
  - [ ]* 2.4 编写商机持久化的单元测试
    - 测试创建订单时保存商机信息
    - 测试更新订单时更新商机信息
    - 测试新客户和已存在客户的不同处理
    - _需求: 1.3, 1.5, 4.1, 4.2, 4.3_
  
  - [ ]* 2.5 编写商机持久化的属性测试
    - **属性 2: 商机信息持久化和更新**
    - **验证需求: 1.3, 1.5**
  
  - [ ]* 2.6 编写数据库持久化的属性测试
    - **属性 7: 客户商机数据库持久化**
    - **验证需求: 4.1, 4.2, 4.3**
  
  - [x] 2.7 添加错误处理和验证
    - 在OrderService中添加商机字段的长度验证
    - 添加数据库操作失败的错误处理
    - 返回明确的错误信息
    - _需求: 4.4, 4.5_
  
  - [ ]* 2.8 编写错误处理的单元测试
    - 测试数据库操作失败时的错误返回
    - 测试前端错误提示显示
    - _需求: 4.4, 4.5_

- [x] 3. 检查点 - 商机录入功能
  - 确保所有测试通过，如有问题请询问用户

- [x] 4. 实现查询条件展开/收起功能
  - [x] 4.1 在QueryForm组件中添加展开状态管理
    - 在frontend/src/components/OrderList/QueryForm.tsx中添加expanded状态
    - 使用useState管理展开/收起状态
    - 实现toggleExpanded函数
    - _需求: 2.1, 2.2_
  
  - [x] 4.2 重构QueryForm的UI布局
    - 将日期范围和公司名称保持始终可见
    - 将其他查询字段包裹在条件渲染中
    - 添加"更多条件"/"收起条件"按钮
    - 根据expanded状态显示/隐藏字段
    - 添加展开/收起图标（UpOutlined/DownOutlined）
    - _需求: 2.1, 2.2, 2.3, 2.4, 2.5_
  
  - [ ]* 4.3 编写查询条件UI的单元测试
    - 测试初始状态只显示两个字段
    - 测试点击按钮后展开所有字段
    - 测试按钮文本和图标的变化
    - 测试收起后恢复初始状态
    - _需求: 2.1, 2.2, 2.3, 2.4, 2.5_
  
  - [x] 4.4 确保查询逻辑使用所有字段值
    - 验证handleSearch函数使用form.getFieldsValue()获取所有值
    - 确保隐藏字段的值也参与查询
    - _需求: 2.6, 2.7_
  
  - [ ]* 4.5 编写查询条件值保持的属性测试
    - **属性 4: 查询条件值保持**
    - **验证需求: 2.6**
  
  - [ ]* 4.6 编写完整查询的属性测试
    - **属性 5: 展开状态下的完整查询**
    - **验证需求: 2.7**

- [x] 5. 检查点 - 查询条件功能
  - 确保所有测试通过，如有问题请询问用户

- [x] 6. 修复统计报表路由导航
  - [x] 6.1 重构App组件使用React Router hooks
    - 在frontend/src/App.tsx中创建AppContent内部组件
    - 在AppContent中使用useNavigate和useLocation hooks
    - 移除手动的window.location.hash操作
    - 使用navigate函数进行编程式导航
    - _需求: 3.1, 3.2_
  
  - [x] 6.2 实现路由变化监听和菜单同步
    - 使用useEffect监听location.pathname变化
    - 根据当前路径更新selectedKey状态
    - 确保菜单高亮与路由同步
    - _需求: 3.3, 3.4, 3.6_
  
  - [x] 6.3 调整BrowserRouter的位置
    - 将BrowserRouter移到AppProvider内部
    - 确保路由hooks可以正常使用
    - 保持ConfigProvider在最外层
    - _需求: 3.1, 3.2_
  
  - [ ]* 6.4 编写路由导航的单元测试
    - 测试点击菜单项是否正确导航
    - 测试URL变化是否切换页面组件
    - 测试菜单高亮是否与路由同步
    - _需求: 3.1, 3.2, 3.3, 3.4, 3.6_
  
  - [ ]* 6.5 编写浏览器历史记录的属性测试
    - **属性 6: 浏览器历史记录同步**
    - **验证需求: 3.5, 3.6**

- [x] 7. 最终检查点
  - 运行所有测试确保通过
  - 手动测试三个功能的用户流程
  - 如有问题请询问用户

## 注意事项

- 标记为`*`的任务是可选的测试任务，可以跳过以加快MVP开发
- 每个任务都引用了具体的需求编号，便于追溯
- 属性测试任务明确标注了对应的属性编号和验证的需求
- 检查点任务确保增量验证和及时发现问题
